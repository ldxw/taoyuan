# 桃源乡 — 功能完整性与回归影响校验清单

> 本清单用于系统性验证游戏各模块的功能完整性，检测潜在的回归影响。
> 每个条目聚焦于**如何验证**，而非如何修复。

---

## 一、核心流程校验（按真实用户操作路径）

### 1.1 新游戏 → 第一天完整流程

- [ ] **启动新游戏**：主菜单点击"新游戏"，选择农场类型，输入角色名，确认进入 GameLayout
- [ ] **初始状态正确**：第 1 年春季第 1 天，金币 500，体力 120/120，HP 100/100，背包 20 格，4 把基础工具
- [ ] **侧边栏导航**：依次点击全部 16 个面板标签，确认每个面板均可正常渲染且无控制台报错
- [ ] **移动端底部导航**：375px 宽度下横向滚动底部导航栏，点击所有面板标签均可切换
- [ ] **开垦 → 种植 → 浇水**：农场面板锄地（消耗体力 + 时间推进），种下作物（消耗种子），浇水（消耗体力）
- [ ] **商店购买种子**：进入商店，确认商品按春季过滤，购买种子后金币扣减、背包新增物品
- [ ] **出售物品**：在商店出售背包中的物品，确认金币增加、物品数量减少
- [ ] **与 NPC 对话**：进入 NPC 面板，点击对话按钮，确认友好度 +2、当日对话标记生效（不可重复对话）
- [ ] **赠送礼物**：选择背包物品送给 NPC，确认友好度按"喜爱/喜欢/讨厌/中性"正确变化，物品消耗
- [ ] **休息/睡觉**：点击日志面板旁的休息按钮，确认日结算流程触发（作物生长、NPC 友好度衰减、天气更新、自动存档）

### 1.2 多日流程（跨天/跨季）

- [ ] **连续 3 天浇水作物**：种植后每天浇水，观察生长天数递增；第 4 天查看作物状态是否与 `growDays` 定义一致
- [ ] **不浇水 2 天 → 作物枯死**：种植后故意不浇水连续 2 天，第 3 天确认作物死亡、地块退回"已翻耕"状态
- [ ] **洒水器自动浇水**：安装洒水器后，新的一天开始时相邻地块自动被浇水（无需手动）
- [ ] **作物成熟 → 收获**：等待作物达到 `growDays`，确认状态变为"可收获"，点击收获后物品进入背包、地块状态正确（一次性作物回到"已翻耕"，再生作物回到"生长中"）
- [ ] **跨季作物枯萎**：春季作物在夏季第 1 天自动枯萎（15% 概率翻耕地块退化、30% 春季退化率）
- [ ] **28 天 → 换季**：确认第 28 天睡觉后进入下一季节，天气池切换，商店商品更新
- [ ] **4 季 → 跨年**：冬季第 28 天睡觉后进入第 2 年春季第 1 天

### 1.3 钓鱼完整流程

- [ ] **抛竿**：钓鱼面板点击开始，消耗体力，根据季节 + 天气筛选鱼池
- [ ] **回合操作**：观察鱼的行为（平静/挣扎/猛冲），分别测试"拉线/放线/等待"三种操作的结果
- [ ] **拉线 + 平静**：自动成功，进度 +1
- [ ] **拉线 + 挣扎**：50% + 技能加成概率成功
- [ ] **拉线 + 猛冲**：40% 断线率（减去技能降低），陷阱浮标首次救线
- [ ] **放线 + 猛冲**：安全操作，保护鱼线
- [ ] **成功钓上**：进度达标后判定品质（技能等级影响），物品入包，经验值获取
- [ ] **鱼逃跑**：回合耗尽但进度不足，无奖励
- [ ] **鱼饵消耗**：每次抛竿消耗 1 个鱼饵
- [ ] **浮标耐久递减**：每次抛竿耐久 -1，耐久归零自动卸下

### 1.4 矿洞探险完整流程

- [ ] **进入矿洞**：当前层 = 安全点 + 1
- [ ] **采矿**：消耗体力，获得矿石（数量 = 基础 1 + 矿工天赋 + 地形加成 + 探矿者翻倍），经验值入账
- [ ] **使用炸弹**：消耗炸弹道具，获得多倍矿石，可选清除怪物
- [ ] **遭遇怪物 → 战斗**：攻击/防御/逃跑三种操作，伤害公式 `BASE_ATTACK + miningLevel × 2 - monster.defense`（最低 1）
- [ ] **战斗胜利**：获得掉落物 + 经验
- [ ] **战斗失败**：丢失 50% 战利品（后入先出），扣除 10% 金币（上限 1000），HP 恢复至 50%，退出矿洞
- [ ] **逃跑**：战斗结束，保留已收集战利品
- [ ] **安全点记录**：经过安全点层后，下次进入从该安全点 +1 开始
- [ ] **最高 30 层封顶**：到达 30 层后无法继续深入

### 1.5 烹饪 + 食用 + 增益

- [ ] **烹饪**：选择已解锁食谱，确认食材消耗、食物物品生成
- [ ] **食用**：消耗食物，体力恢复 × 炼金师加成（1.5×）× 厨师加成
- [ ] **增益生效**：食用带增益的食物后，当日增益激活（如"钓鱼 +5%"），直到日结算重置
- [ ] **增益互斥**：再次食用其他增益食物，确认旧增益被覆盖（每日仅 1 个增益）

### 1.6 加工系统完整流程

- [ ] **制造机器**：消耗材料 + 金币，机器数量 +1（上限 6 台）
- [ ] **开始加工**：选择配方，消耗原材料，加工槽位进入"加工中"
- [ ] **每日推进**：日结算时 `daysProcessed++`，达到 `totalDays` 后变为"已完成"
- [ ] **收取产品**：点击收取，产品入包，槽位清空可复用
- [ ] **拆除机器（加工中）**：原材料退还至背包

### 1.7 存档/读档

- [ ] **自动存档**：每日结算后自动保存至槽位 0
- [ ] **手动存档**：保存至槽位 1/2，覆盖旧存档，显示摘要（年/季/天/金币）
- [ ] **读档恢复**：加载存档后所有 15 个 store 状态正确还原（金币、背包、作物、NPC 友好度、技能等级等）
- [ ] **空槽位加载**：尝试加载无数据槽位，确认返回 false 且不影响当前游戏
- [ ] **跨版本兼容**：旧存档中缺失字段（如新增的 `wallet` 数据）通过 `?? defaultValue` 安全回退

---

## 二、需求覆盖校验（需求 ↔ 实现是否一致）

### 2.1 四季轮回

- [ ] **28 天/季**：验证 `DAYS_PER_SEASON = 28`，第 28 天 → 第 1 天 + 季节切换
- [ ] **天气系统**：晴/雨/雷雨/雪/大风均可出现，且影响农事（雨天自动浇水、雷雨闪电劈作物）
- [ ] **星期循环**：`(day - 1) % 7` 映射周一到周日，商店按星期休息

### 2.2 田庄经营

- [ ] **农场扩建 3 阶**：4×4 → 6×6 → 8×8，扩建后保留已有地块状态
- [ ] **肥料系统**：每块地最多 1 种肥料，提供生长加速/品质提升/保湿效果
- [ ] **品质影响售价**：普通 ×1.0、优良 ×1.25、精品 ×1.5、极品 ×2.0
- [ ] **温室**：解锁后自动浇水、忽略天气和季节限制、12 块地

### 2.3 技能成长

- [ ] **4 大技能**：农耕/采集/钓鱼/挖矿各有独立经验和等级（0-10）
- [ ] **经验表**：`[0, 100, 250, 500, 800, 1200, 1500, 1950, 2500, 3200, 4200]`，验证升级阈值
- [ ] **等级 5 专精**：每技能可选 1 个天赋，选后不可更改
- [ ] **等级 10 专精**：同上，独立于等级 5 选择
- [ ] **体力减免**：每级 10% 减免，等级 10 = 100% 减免

### 2.4 乡里社交

- [ ] **6 位 NPC**：陈伯、柳娘、阿石、秋月、林老、小满均可对话/送礼
- [ ] **友好度等级**：陌生人 (0-49)、熟人 (50-149)、友好 (150-299)、挚友 (300+)
- [ ] **心事件**：友好度达到阈值且事件未触发时，对话触发心事件
- [ ] **求婚系统**：友好度 ≥ 300 + 玉戒 + 无现有配偶 → 求婚成功
- [ ] **配偶助手**：每日 40-50% 浇水、30-40% 喂养、25-30% 烹饪
- [ ] **子嗣系统**：结婚 ≥ 7 天 + 配偶友好度 ≥ 250 + 子女 < 2 → 5% 每日概率受孕，14 天分娩

### 2.5 矿洞探险

- [ ] **30 层 3 区域**：浅矿/深矿/熔岩，每区域怪物和矿石不同
- [ ] **回合制战斗**：攻击 = `BASE_ATTACK(10) + miningLevel × 2`，最低伤害 1
- [ ] **战败惩罚**：50% 战利品（后入先出）+ 10% 金币（上限 1000）

### 2.6 烹饪/加工

- [ ] **初始 7 道食谱**：炒白菜、蜂蜜茶、姜汤、竹笋炒肉、柿饼、芝麻糊、玉米饼
- [ ] **NPC/技能解锁食谱**：友好度达标 + 技能等级达标，日结算时检查解锁
- [ ] **加工**：酿酒/腌制/磨粉等配方，消耗原料 + 天数 → 产出高价值商品
- [ ] **蜂箱特殊**：无需原料，被动产出蜂蜜

### 2.7 委托系统

- [ ] **每日 1-2 个新委托**：日结算时清除旧公告板、生成新委托
- [ ] **最多 3 个活跃委托**：接取上限校验
- [ ] **4 种类型**：送货/钓鱼/挖矿/采集，送货类在提交时扣物品，其余自动追踪
- [ ] **过期机制**：`daysRemaining--` 每天，归零后静默移除

### 2.8 畜牧系统

- [ ] **建造畜棚/鸡舍**：消耗材料和金币
- [ ] **购买动物**：需要建筑已建造且有容量
- [ ] **喂养 + 抚摸**：每日一次，影响友好度和心情
- [ ] **产出品质**：友好度 0-199 普通、200-499 优良、500-799 精品、800+ 极品
- [ ] **草地农场加成**：友好度增长 ×1.5

### 2.9 家园升级

- [ ] **4 阶段**：茅屋 → 砖房 → 宅院 → 酒窖宅院
- [ ] **洞穴选择**：累计收入 ≥ 25000 解锁（`CAVE_UNLOCK_EARNINGS`），蘑菇/果蝠二选一且不可更改
- [ ] **酒窖陈酿**：每 7 天品质提升一级，最高极品

---

## 三、边界/异常校验

### 3.1 数值边界

- [ ] **体力归零**：体力 = 0 时尝试执行需体力操作（锄地/浇水/采矿），确认操作被拒绝、不进入负数
- [ ] **体力 ≤ 15 疲劳提示**：`isExhausted` 标记生效，UI 显示警告
- [ ] **HP 归零**：矿洞战斗中 HP 降至 0，触发战败流程（不出现负数 HP）
- [ ] **金币归零**：金币 = 0 时尝试购买，确认操作拒绝；昏倒惩罚不导致负数金币
- [ ] **背包满载**：20/20 格时尝试获取新物品，确认拒绝且不丢失已有物品
- [ ] **堆叠上限 99**：持有 99 个同品质物品时再获取，确认处理正确（新开一格或拒绝）
- [ ] **时间上限 26 时**：时间推至 26 时（凌晨 2 点），强制昏倒结算

### 3.2 操作边界

- [ ] **重复对话**：同一天对同一 NPC 连续点击对话，确认仅首次生效
- [ ] **重复送礼**：同一天对同一 NPC 送两次礼物，确认仅首次生效
- [ ] **重复喂养/抚摸**：同一天对同一动物操作两次，确认标记防重复
- [ ] **空地块操作**：对"荒地"浇水/种植/施肥/收获，确认各操作正确拒绝或接受
- [ ] **已种植地块重复种植**：确认拒绝操作
- [ ] **无种子种植**：背包无种子时点击种植，确认提示或拒绝
- [ ] **无鱼饵钓鱼**：确认是否允许无饵钓鱼或正确拒绝
- [ ] **矿洞 30 层继续前进**：确认无法超过最高层

### 3.3 季节边界

- [ ] **冬季种植**：确认冬季无可种植作物（或仅限温室）
- [ ] **冬季钓鱼**：确认冬季鱼池正确过滤
- [ ] **季节专属物品**：确认采集物按季节正确生成

### 3.4 存档边界

- [ ] **槽位越界**：代码级验证 `0 ≤ slot < MAX_SLOTS(3)`
- [ ] **localStorage 容量**：大量作物 + 物品 + NPC 状态下存档不超过 5MB 限制
- [ ] **损坏存档加载**：手动篡改 localStorage 中的 JSON，确认 `deserialize` 通过 `?? defaultValue` 安全回退

---

## 四、数据与状态一致性校验

### 4.1 跨 Store 一致性

- [ ] **日结算顺序**：`farmStore.dailyUpdate()` → `npcStore.dailyReset()` → `animalStore.dailyUpdate()` → `gameStore.nextDay()` → `playerStore.dailyReset()`，顺序不可打乱
- [ ] **技能等级 → 伤害公式**：`useSkillStore.level` 变化后，`useMiningStore` 的攻击力同步更新（非缓存旧值）
- [ ] **技能等级 → 品质概率**：`useSkillStore.level` 变化后，作物/鱼/采集品质概率同步更新
- [ ] **钱包商店 → 各系统加成**：`useWalletStore` 的 `getCropGrowthBonus()`、`getFishingCalmBonus()` 等在各系统中实时读取
- [ ] **背包变动 → 委托追踪**：通过采矿/钓鱼/采集获取物品时，`questStore.onItemObtained()` 被正确调用
- [ ] **NPC 友好度 → 食谱解锁**：友好度提升至非"陌生人"后，日结算 `checkRecipeUnlocks()` 正确触发

### 4.2 存档 ↔ 运行时一致性

- [ ] **保存 → 加载往返**：保存后立即加载同一槽位，比对所有 store 状态值（金币、体力、HP、背包、作物、NPC 友好度、技能等级、矿洞进度、食谱列表、加工槽位、成就列表、动物状态、家园等级、钓具耐久、钱包解锁、委托列表）
- [ ] **肥料迁移**：旧存档中 `compost` 加载后自动映射为 `basic_fertilizer`，`bone_meal` → `deluxe_speed_gro`
- [ ] **新增字段回退**：模拟旧存档缺少 `wallet`/`quest` 等字段，确认 `?? defaultValue` 生效

### 4.3 UI ↔ 数据一致性

- [ ] **StatusBar 体力条**：`playerStore.staminaPercent` 与进度条宽度一致
- [ ] **StatusBar HP 条**：`playerStore.hp / maxHp` 与进度条一致
- [ ] **StatusBar 时间条**：`(hour - 6) / (26 - 6)` 百分比与进度条一致
- [ ] **StatusBar 金币**：显示值 = `playerStore.money`
- [ ] **农场网格**：地块数量 = `farmSize × farmSize`（16/36/64）
- [ ] **背包格子数**：显示格子 = `inventoryStore.capacity`
- [ ] **侧边栏高亮**：当前路由 `route.name` 与高亮标签 `tab.key` 匹配
- [ ] **移动端底部导航**：图标和标签与 `useNavigation.TABS` 定义一致

### 4.4 成就与统计一致性

- [ ] **作物收获统计**：每次收获调用 `recordCropHarvest()`，`stats.totalCropsHarvested` 与实际操作次数一致
- [ ] **钓鱼统计**：每次钓上调用 `recordFishCaught()`，累计值正确
- [ ] **累计收入**：`recordMoneyEarned(amount)` 在出售/委托奖励时调用，累计值正确
- [ ] **矿洞最高层**：`recordMineFloor(floor)` 取最大值，不因死亡回退
- [ ] **物品发现**：`discoverItem(itemId)` 去重，同一物品不重复计入

---

## 五、回归影响校验（近期改动对旧功能的影响）

### 5.1 function → const 箭头函数转换

- [ ] **Store 内部函数 this 绑定**：Pinia composition API store 不使用 `this`，确认转换后所有 store action/getter 正常工作
- [ ] **hoisted 函数调用**：`function` 声明有提升（hoisting），`const` 没有——确认没有先使用后声明的情况
- [ ] **具名函数递归**：检查是否存在递归调用自身的函数，箭头函数赋值给 const 后递归仍有效（因为已声明变量名）
- [ ] **导出函数签名**：`export const fn = () => {}` 与 `export function fn() {}` 在类型推断上一致，确认所有组件 import 无类型错误
- [ ] **vue-tsc 零错误**：运行 `vue-tsc -b`（或 `vue-tsc --noEmit`），确认零类型错误
- [ ] **vite build 成功**：运行 `vite build`，确认零构建错误

### 5.2 lucide-vue-next 图标集成

- [ ] **图标渲染**：每个面板标签（16 个）在侧边栏和底部导航中正确显示对应图标
- [ ] **StatusBar 图标**：体力（Zap）、HP（Heart）、时间（Clock）、金币（Coins）、音效（Volume2/VolumeX）、音乐（Music）正确显示
- [ ] **游戏面板图标**：16 个游戏面板内的按钮/标题中图标正确渲染（无缺失、无错位）
- [ ] **图标 size 属性**：`:size="14"` 等参数生效，图标尺寸符合预期
- [ ] **Tree-shaking**：`vite build` 后 bundle 体积未因引入整个 lucide 库而显著增大（应按需导入）

### 5.3 移动端响应式适配

- [ ] **侧边栏隐藏**：`< 768px` 时侧边栏 `hidden`，`≥ 768px` 时 `flex` 显示
- [ ] **底部导航**：`< 768px` 时底部导航显示，`≥ 768px` 时 `hidden`
- [ ] **日志面板折叠**：移动端可点击"日志"标题折叠/展开
- [ ] **休息按钮可达**：桌面端和移动端均可从日志面板旁的休息按钮触发睡觉
- [ ] **StatusBar 两行布局**：移动端 StatusBar 分两行且不溢出
- [ ] **触摸目标 ≥ 36px**：`.btn` 的 `min-height: 36px` 生效
- [ ] **商店双栏 → 单栏**：ShopView 在窄屏下 `flex-col`，宽屏 `flex-row`
- [ ] **网格列数适配**：InventoryView `grid-cols-3 md:grid-cols-5`、AchievementView `grid-cols-2 md:grid-cols-4`、NpcView `grid-cols-1 md:grid-cols-2`

### 5.4 CSS/样式回归

- [ ] **`.btn` 样式优先级**：未分层 CSS `.btn` 与 Tailwind `@layer utilities` 类共存，`!important` 覆盖生效
- [ ] **`.game-panel` padding**：移动端 12px、桌面端 16px
- [ ] **`#app` padding**：移动端 8px、桌面端 16px
- [ ] **安全区域**：`viewport-fit=cover`，底部导航含 `padding-bottom: env(safe-area-inset-bottom)`

---

## 六、长时间运行/重复操作校验

### 6.1 多日模拟（≥ 112 天 = 1 完整年）

- [ ] **连续睡觉 28 天**：快速跳过一整季，确认季节正确切换、天气池更新、作物全部枯萎
- [ ] **连续睡觉 112 天**：跳过完整一年，确认年份 +1、季节回到春、各系统状态正常
- [ ] **体力恢复模式交替**：交替测试正常/晚睡/昏倒恢复，确认体力值始终在合法范围内

### 6.2 重复操作压力

- [ ] **反复存档/读档 50 次**：连续保存→加载→保存→加载，确认数据无漂移
- [ ] **反复进出矿洞 20 次**：进入 → 采矿 → 退出 → 再进入，确认层数、安全点、战利品状态正确
- [ ] **反复钓鱼 30 次**：连续钓鱼直到体力耗尽，确认鱼饵/浮标消耗、经验累加、背包容量检查
- [ ] **反复购买/出售**：在商店中快速买卖同一物品，确认金币和库存始终一致
- [ ] **反复种植/收获 1 整季**：全部地块种满 → 每日浇水 → 收获 → 再种，28 天循环无异常

### 6.3 状态累积检查

- [ ] **背包长期使用**：持续获取不同物品直到接近 36 格上限，确认堆叠和新开格位逻辑正确
- [ ] **NPC 友好度长期累积**：每日对话 + 送礼，观察友好度是否持续增长且不出现异常跳变
- [ ] **技能经验长期累积**：确认经验值在 0-4200 范围内，等级在 0-10 范围内，不出现溢出
- [ ] **成就逐步解锁**：随游戏进程推进，成就按条件依次解锁，已解锁成就不重复奖励
- [ ] **加工槽位长期运转**：6 台机器同时加工，连续多日收取 → 重新投放，槽位状态正确
- [ ] **子嗣系统长期**：婚后等待受孕 → 14 天分娩 → 子女成长阶段切换（婴儿 → 幼童 → 孩童 → 少年），全流程无异常

### 6.4 localStorage 稳定性

- [ ] **存档体积监控**：游戏进行 1 年后，检查 `localStorage.getItem('taoyuanxiang_save_0').length`，确认未超过 2MB
- [ ] **多槽位共存**：3 个槽位均有存档时，各自独立加载无串扰
- [ ] **浏览器刷新恢复**：游戏中刷新页面，重新加载存档后状态与刷新前一致

---

## 附录：高风险区域汇总

| 风险等级 | 区域 | 说明 |
|----------|------|------|
| **高** | 存档/读档 | 无事务语义，部分反序列化失败会导致数据污染 |
| **高** | 日结算顺序 | 14 个 store 按序更新，顺序错误会导致连锁数据不一致 |
| **高** | 矿洞战利品 LIFO | 后入先出丢失，可能优先丢失稀有掉落而非普通矿石 |
| **中** | 闪电劈作物 | 暴风雨 25% 概率，无保护机制，随机选中地块 |
| **中** | 钓具耐久归零 | 耐久 = 0 时自动卸下，损坏钓具无法回收 |
| **中** | 洞穴选择不可逆 | 蘑菇/果蝠一旦选定永久锁定 |
| **中** | 委托静默过期 | 到期委托无通知直接消失 |
| **低** | 子女命名池耗尽 | 8 个名字用完后全部默认"小宝" |
| **低** | 动物心情未使用 | mood 字段被追踪但未影响任何游戏逻辑 |
| **低** | 家园体力恢复加成 | `getStaminaRecoveryBonus()` 可能未被实际调用 |

---

## 代码级自动校验结果

> 以下为通过静态代码分析完成的校验项，标注 PASS/FAIL 及对应源码行号。

### 构建与类型检查

| 校验项 | 结果 | 说明 |
|--------|------|------|
| `vue-tsc -b` 类型检查 | **PASS** | 零错误 |
| `vite build` 生产构建 | **PASS** | 1803 模块，4.96s 构建成功 |
| `function` 声明残留 | **PASS** | grep 零匹配，全部已转为 `const` 箭头函数 |

### 日结算流程 (`useEndDay.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 恢复模式判定 (passout/late/normal) | **PASS** | 120-127 | `stamina ≤ 0 \|\| hour ≥ 26` → passout, `hour ≥ 24` → late, else normal |
| 顺序执行（farm→npc→game→player→save） | **PASS** | 129, 156, 234, 235, 322 | 正确顺序 |
| 配偶助手概率 | **PASS** | 132-154 | 浇水 40%+, 喂养 30%+, 烹饪 25%+, 友好度 ≥300 额外 +10% |
| 闪电劈作物（仅雷暴） | **PASS** | 270-276 | `gameStore.weather === 'stormy'` 条件判断后调用 |
| 食谱解锁（NPC + 技能双通道） | **PASS** | 49-72 | 同时检查 NPC 友好度等级和技能等级 |
| 洞穴解锁阈值 | **PASS** | 306 | `totalMoneyEarned >= CAVE_UNLOCK_EARNINGS`（25000G） |
| 委托更新（过期 + 生成） | **PASS** | 214-219 | `dailyUpdate()` 过期旧委托，`generateDailyQuests()` 生成新委托 |
| 换季处理（枯萎 + 退化） | **PASS** | 254-268 | `onSeasonChange()` 处理作物枯萎和翻耕退化 |
| 自动存档 slot 0 | **PASS** | 322 | `saveStore.saveToSlot(0)` 在日结算末尾调用 |

### 存档系统 (`useSaveStore.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 15 个 store 全部序列化 | **PASS** | 75-89, 118-132 | game/player/inventory/farm/skill/npc/mining/cooking/processing/achievement/animal/home/fishing/wallet/quest |
| 槽位边界 `0 ≤ slot < 3` | **PASS** | 57, 138 | save 和 delete 均有校验 |
| 存档摘要信息 | **PASS** | 42-46, 90 | year/season/day/money/savedAt |
| 肥料迁移 (compost → basic_fertilizer) | **PASS** | `useFarmStore.ts:520-533` | 在 farm store 的 `deserialize()` 中实现 |
| 部分 store 缺 `??` 回退 | **WARN** | — | `useGameStore` 的 year/season/day 无 `??`；`useInventoryStore` 全部直接赋值无 `??` |
| localStorage 无 try-catch | **FAIL** | — | `getSlots/saveToSlot/loadFromSlot` 均无异常捕获，JSON.parse 失败将崩溃 |

### 农场系统 (`useFarmStore.ts` + `useFarmActions.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 地块状态机 (wasteland→tilled→planted→growing→harvestable) | **PASS** | 54-74, 219-222 | 完整状态转换链 |
| 2 天不浇水作物枯死 | **PASS** | 224-232 | `unwateredDays >= 2` → tilled |
| 洒水器覆盖 (4格/8格) | **PASS** | 114-149 | 4 向 + 8 向正确实现 |
| 肥料唯一性 + 生长加速 | **PASS** | 189-196, 214-217 | `if (plot.fertilizer) return false` + `growthIncrement = 1 + speedup` |
| 果树 28 天成熟 | **PASS** | 344-346 | `growthDays >= 28` |
| 果树品质 (0/1/2/3+ 季) | **PASS** | 360-365 | normal/fine/excellent/supreme |
| 换季枯萎 (15%/30% 退化) | **PASS** | 246-277 | `newSeason === 'spring' ? 0.3 : 0.15` |
| 农场扩建 4→6→8 保留地块 | **PASS** | 300-320 | 旧地块按坐标映射到新网格 |
| 温室自动浇水 | **PASS** | 490-506 | 无条件 `plot.watered = true` |
| 再生作物回到 growing | **PASS** | 93-98 | `growthDays = totalDays - regrowthDays` |
| 闪电劈 25% 概率 | **PASS** | 280-297 | `Math.random() > 0.25 → no hit`（调用者负责 storm 检查） |

### 矿洞系统 (`useMiningStore.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 楼层起始 = safePointFloor + 1 | **PASS** | 46 | |
| 矿石数量公式 | **PASS** | 100-105 | base 1 + miner(1) + hilltop(1) + prospector(×2, 25%) |
| 战斗伤害公式 | **PASS** | 206-207 | `BASE_ATTACK + miningLevel * 2`, `Math.max(1, ...)` |
| 战败惩罚 | **PASS** | 258-270 | 50% loot LIFO + 10% money cap 1000 + HP 50% |
| 逃跑保留战利品 | **PASS** | 185-189 | `inCombat = false`，不触发 handleDefeat |
| 安全点更新 | **PASS** | 289-292 | `isSafePoint → safePointFloor = currentFloor` |
| 最高 30 层 | **PASS** | 284-286 | `currentFloor >= 30 → return false` |

### 钓鱼系统 (`useFishingStore.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 行为概率 40/35/25 | **PASS** | 173-175 | calm 0.4, struggle 0.35, dash implicit 0.25 |
| 拉线 + 平静 = 自动成功 | **PASS** | 210-213 | |
| 拉线 + 挣扎 = 50% + 多项加成 | **PASS** | 214-228 | skill 5%/lv + trapper 15% + cork + fishingBuff |
| 拉线 + 猛冲 = 40% - 3%/lv 断线 | **PASS** | 229-244 | trap_bobber 首次救线 |
| 放线 + 猛冲 = 安全 | **PASS** | 246-249 | |
| 钓到条件 reelCount ≥ requiredReel | **PASS** | 264 | |
| 逃跑条件 round 耗尽 | **PASS** | 288-291 | |
| 鱼饵消耗 | **PASS** | 111-113 | |
| 浮标耐久递减 | **PASS** | 117-122 | |

### NPC 系统 (`useNpcStore.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 友好度等级阈值 | **PASS** | 9-14 | bestFriend 300+, friendly 150+, acquaintance 50+, stranger 0+ |
| 对话 +2, 每日一次 | **PASS** | 107-135 | `talkedToday` flag |
| 送礼公式（喜爱/喜欢/讨厌/中性） | **PASS** | 138-181 | 10/3/-5/1 × quality × birthday(5×) |
| 每日衰减 -1 (已婚 -2) | **PASS** | 286-303 | floor at level threshold |
| 求婚条件 | **PASS** | 184-205 | friendship ≥ 300, jade_ring, no existing spouse |
| 子嗣系统 (5%, 14天, max 2) | **PASS** | 213-269 | `Math.random() < 0.05`, countdown 14 |
| 心事件一次性触发 | **PASS** | 78-96 | `triggeredHeartEvents` 防重复 |

### 玩家/背包边界 (`usePlayerStore.ts` + `useInventoryStore.ts`)

| 校验项 | 结果 | 行号 | 说明 |
|--------|------|------|------|
| 初始金币 500 | **PASS** | playerStore:21 | |
| 体力 120→150→180 | **PASS** | playerStore:12, 103-108 | STAMINA_CAPS = [120, 150, 180] |
| HP = 100 + miningLv×5 + perks | **PASS** | playerStore:34-42 | fighter +15, warrior +25 |
| consumeStamina 不进负数 | **PASS** | playerStore:53-57 | `if (stamina < amount) return false` |
| takeDamage 不进负数 | **PASS** | playerStore:65-69 | `Math.min(amount, hp)` |
| spendMoney 不进负数 | **PASS** | playerStore:111-115 | `if (money < amount) return false` |
| 背包容量 20→36 | **PASS** | inventoryStore:5-6 | INITIAL=20, MAX=36 |
| 堆叠上限 99 | **PASS** | inventoryStore:7, 25, 30 | `Math.min(qty, MAX_STACK - existing)` |
| 背包满拒绝 | **PASS** | inventoryStore:22-32 | `isFull` computed 检查 |

### 其他系统

| 系统 | 校验项 | 结果 | 说明 |
|------|--------|------|------|
| 委托 | 每日 1-2 个, 清旧板 | **PASS** | `1 + Math.floor(Math.random() * 2)` |
| 委托 | 最多 3 个活跃 | **PASS** | MAX_ACTIVE_QUESTS = 3 |
| 委托 | 送货类提交时扣物品 | **PASS** | |
| 委托 | 非送货类自动追踪 | **PASS** | `onItemObtained()` |
| 委托 | 过期递减移除 | **PASS** | |
| 烹饪 | 初始 7 食谱 | **PASS** | |
| 烹饪 | 消耗食材产出食物 | **PASS** | |
| 烹饪 | 炼金师 1.5× + 厨师加成 | **PASS** | |
| 烹饪 | 每日 1 增益, 日结清除 | **PASS** | |
| 加工 | 最多 6 台 | **PASS** | MAX_MACHINES = 6 |
| 加工 | 每日推进, 达标就绪 | **PASS** | |
| 加工 | 收取清空槽位 | **PASS** | |
| 加工 | 拆除退还原料 | **PASS** | |
| 技能 | 经验表 11 级 | **PASS** | |
| 技能 | 最高 10 级 | **PASS** | |
| 技能 | 天赋不可重选 | **PASS** | `perk5 !== null → return false` |
| 技能 | 每级 10% 体力减免 | **PASS** | `level * 0.1` |
| 动物 | 建筑前置条件 | **PASS** | |
| 动物 | 友好度变化公式 | **PASS** | -10 unfed, +15 both × meadowlands 1.5 |
| 动物 | 产品品质阈值 | **PASS** | 200/500/800 |
| 家园 | 4 阶段升级 | **PASS** | |
| 家园 | 洞穴不可逆选择 | **PASS** | `caveChoice !== 'none' → false` |
| 家园 | 酒窖 7 天升品质 | **PASS** | |
| 时间 | 28 天换季 | **PASS** | `day > 28 → season++` |
| 时间 | 4 季跨年 | **PASS** | `nextIndex >= 4 → year++` |
| 时间 | 昏倒时间 26 | **PASS** | PASSOUT_HOUR = 26 |

### 移动端响应式 + 图标集成

| 校验项 | 结果 | 说明 |
|--------|------|------|
| viewport-fit=cover | **PASS** | index.html |
| .btn min-height: 36px | **PASS** | style.css:82 |
| 侧边栏 hidden md:flex | **PASS** | GameLayout.vue:17 |
| 底部导航 flex md:hidden | **PASS** | GameLayout.vue:59 |
| 休息按钮桌面+移动端可达 | **PASS** | GameLayout.vue + StatusBar.vue 各有一处 |
| StatusBar 两行布局 + 图标 | **PASS** | Zap/Heart/Clock/Coins/Volume/Music |
| 16 个导航标签均有 icon | **PASS** | useNavigation.ts:45-62 |
| ShopView flex-col md:flex-row | **PASS** | |
| InventoryView grid-cols-3 md:5 | **PASS** | |
| AchievementView grid-cols-2 md:4 | **PASS** | |
| NpcView grid-cols-1 md:2 | **PASS** | |
| 底部导航安全区域 padding | **PASS** | style.css env(safe-area-inset-bottom) |
| 日志面板移动端可折叠 | **PASS** | logExpanded toggle |

---

## 发现的问题汇总

### 需修复

| # | 严重度 | 位置 | 问题描述 |
|---|--------|------|----------|
| 1 | **高** | `useSaveStore.ts` | `localStorage.getItem/setItem` 和 `JSON.parse` 均无 try-catch，存储满/损坏时应用崩溃 |
| 2 | **中** | `useGameStore.ts:219-225` | `deserialize()` 中 `year`/`season`/`day`/`weather`/`currentLocation` 无 `?? defaultValue` 回退 |
| 3 | **中** | `useInventoryStore.ts:94-98` | `deserialize()` 中 `items`/`capacity`/`tools` 全部直接赋值无 `??` 回退 |

### 设计关注（非 Bug）

| # | 位置 | 说明 |
|---|------|------|
| 1 | `useFarmStore.ts:lightningStrike()` | 函数本身不检查 storm 条件，依赖调用者（`useEndDay.ts:270`）负责。调用链正确但较脆弱 |
| 2 | `useGameStore.ts:163` | `DAYS_PER_SEASON` 硬编码 28 而非导出常量 |
| 3 | `useGameStore.ts:222` | `deserialize()` 中 `hour` 有 `??` 回退但无范围校验 (0-26) |
| 4 | `useMiningStore.ts:258-270` | 战利品 LIFO 丢失可能导致先丢稀有掉落，体验不佳 |
